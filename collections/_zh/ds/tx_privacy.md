---
title: 隐私交易
chapter: 4
order: 4
layout: default.zh
lang: zh
---

* auto-gen TOC
{:toc}

# 隐私交易

## 前言

保护交易隐私在密码学货币的发展历史上一直是一个很重要的分支，BIP32、CoinJoin、Zerocoin、Monero、Grin等等都是这个技术方向上的代表。过去，这些技术主要应用在UTXO模型的密码学货币上，如何在World State账户模型的RADR上实现更好的交易隐私保护一直是雷达实验室的研究课题，同为World State账户模型的Ripple和Ethereum在这个方向上也一直进展缓慢没有实质性的突破，RADR可以说是第一个在World State账户模型上实现了无条件的交易隐私保护的密码学货币。

目前，主流的隐私保护技术有三类，CoinJoin、Ring Confidential Transaction、Zero Knowledge Proof。其中，CoinJoin通常需要依赖一个中心化或半中心化的服务，完全去中心化的方案非常复杂并且要求较为苛刻鲜有实现，很难达到无条件的隐私保护，在一段时间的研究之后被宣告排除。我们也投入了很多精力研究零知识证明，零知识证明这个技术被应用到了很多项目上，但经过一段时间的研究之后我们发现这个技术也有不少弊端，其中有两个弊端我们认为会严重影响使用体验。第一个弊端是在World State账户模型上会造成存储空间和计算效率的严重浪费，这是由于零知识证明的所有历史交易都必须保存和用于计算，同时额外需要保存密钥指纹防止双花。第二个弊端是，一笔转账需要通过四笔交易才能最终完成，首先需要将明文余额转为零知识余额，然后声明一个零知识余额转出，之后接收方声明一个零知识余额转入，再将零知识余额转为明文余额。最终，我们决定采用Ring Confidential Transaction技术，这个技术的优势在于只需要两次交易就可以完成，提取完毕的环数据可以直接从World State里删除，不会浪费存储空间，同时还有很好的延展性，保护交易对手方的同时也可以保护交易金额。[关于交易隐私的WhitePaper](https://github.com/radrbiz/radard/blob/master/doc/Transaction_Privacy.pdf)。

![tx-privacy](/assets/images/ds/tx-privacy.png){:height="900px" width="900px"}

## 原理简述

通过两步完成交易双方关联性的消除。

1. Deposit
   1. 生成一个随机的密钥对 (Pk,Sk)
   2. 将要发送的金额及公钥Pk发送至一个环
   3. 当环中累计一定数量的Pk后即可进入下一步
2. Withdraw
   1. 使用私钥Sk和环中所有Pk生成环签名σ和密钥指纹I。
   2. 发送环ID、环签名σ和指纹I至环领取金额。

* 消除关联：
  * 同一个环中的金额需一致，从而无法从金额推断发送方；
  * 环签名的验证需要所有的Pk和I，从I无法反推Sk，因此无法推测发送方;
* 双花：同一个Sk只能生成同一个I，因此可以通过检查I是否已使用来避免双花。

环签名主要原理如下：

记一个环所有公钥为`Pk[N]`，某发送方位于位置j，记其密钥对为`(Pk[j], Sk[j])`，对于
基点G有`Pk[j]=Sk[j]*G`。

计算密钥指纹
* `I=Sk[j]*Hp(Pk[j])`

其中`Hp()`为散列到曲线上的一个点的算法。

随机选取大数`r`，计算
* `L[j]=r*G`
* `R[j]=r*Hp(Pk[j])`
* `c[j+1]=hash(m,L[j],R[j])`

其中`hash()`为散列函数，`m`为待签名的内容。

另取随机数赋值给`s[j+1]`，循环计算
* `L[j+1]=s[j+1]*G + c[j+1]*Pk[j+1]`
* `R[j+1]=s[j+1]*Hp(Pk[j+1]) + c[j+1]*I`
* `c[j+2]=hash(m,L[j+1],R[j+1])`

直至`L[j-1],R[j-1],c[j]`

取`s[j]=(r - c[j]*Sk[j]) % l`构造签名`σ=(I,c[1],s[1],...,s[n])`

此时有
* `r=(s[j] + c[j]*Sk[j]) % l`
* `L[j] = r*G = s[j]*G + c[j]*Sk[j]*G = s[j]*G + c[j]*Pk[j]`
* `R[j] = r*Hp(Pk[j]) = s[j]*Hp(Pk[j]) + c[j]*I`

此处其他人看来`s[j]`和其他`s[i]`并没有区别，无法获知`j`究竟是几因此无法定位具体
签名者是谁；同时，如果不知道`Sk[j]`也无法从`L[j]`或`R[j]`推算`s[j]`，保证了签名
者肯定知道`Sk[j]`，即不可能有环外的人伪造签名。

所以，校验时只需计算所有的`c[i+1],L[i],R[i]`并校验
* `c[i+1]=hash(m,L[i],R[i])`
* `c[n+1]=c[1]`

即可证明签名有效

另外，`R[i]`的计算依赖`I`且`I`无法通过`R[i]`推算，无法伪造；同时，`I`并不能推算
出`Sk[j]`或`Pk[j]`，即不会暴露`j`。因此，`I`未被使用过即保证了此签名为某一签名者
的唯一签名。

## 存取说明

### Deposit

#### Deposit成功的条件
1. 使用同样金额发送相同的资产到一个环上，同一个账号只能发送一笔交易到同一个环；
2. 从第一笔交易发送到环上开始，至少需要等待200个ledger
3. 至少需要5笔交易才能组成一个环，最大交易笔数为20笔；

#### 操作说明

发起方在隐私交易转账页面发起交易，首先选择一档金额，下方会显示当前最新环的信息。

![deposit](/assets/images/ds/deposit-1.png)

发起方在选择好金额后，点击下一步，系统会提示保存私钥信息。
>注意，请保管好系统为您生成的私钥，一旦丢失，发出的资产将无法找回！为了避免损失，请妥善保管好您的私钥数据。

系统生成的本地私钥格式为 radr-xx-xx-xxxxxxxxxxxxxx, 我们使用-将其分割为四个部分，radr-part1-part2-part3; 其中，
1. radr为保留字段
2. part1: 该环的金额
3. part2: 环的id信息
4. part3: 私钥信息

![deposit](/assets/images/ds/deposit-1.png)

最后点击确认发送交易。

### Withdraw

#### Withdraw的条件
1. 执行Withdraw的账号不能是环中操作过Deposit的账号之一
2. 环组成成功才能执行Withdraw操作
3. 私钥是资产所有的唯一证明，失去私钥意味着失去了该笔资产

#### 操作说明

用户进入隐私交易提取页面，在页面输入私钥信息

![withdraw](/assets/images/ds/withdraw.png)

点击确认提取，私钥信息无误则会将该私钥对应的资产取出。相应的在下方会显示当前提款的历史。

![withdraw](/assets/images/ds/withdraw-1.png)



